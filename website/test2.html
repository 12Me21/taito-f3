<!doctype html>

<style>
	@font-face {
		font-family: 'mspm';
		src: url("./short2.otf?4");
	}
	body {
		font-family: mspm, georgia;
		font-variant: tabular-nums;
	}
	h1 {
		font-variant: lining-nums;
	}

	dl.bits > dt, table.bits td {
		font-family: mspm, times new roman;
	}
	f3-struct, f3-addr, f3-data {
		display: flex;
		flex-direction: column;
		align-items: flex-start;
	}
	f3-struct {
		margin-bottom: 1em;
	}
	f3-struct {
		border-left: solid black;
		padding: 0.5em 0 0.5em 1em;
	}
	f3-struct h1 {
		//font-style: italic;
		margin: 0;
		font-size: 1.5em;
		margin-bottom: 0.5em;
		margin-left: -0.25em;
	}
	f3-struct f3-addr h1, f3-struct f3-data h1 {
		font-size: 1.2em;
		margin: 0;
	}
	f3-struct dl dl {
		margin-left: 0;
		margin-top: 0;
		margin-bottom: 0;
	}
	f3-struct dl dl dt {
		font-size: unset;
	}
	dl[compact] {
		display: flex;
		flex-wrap: wrap;
	}
	dl[compact] > dd {
		margin: 0;
	}
	dl[compact] > dd:not(:last-child) {
		margin-right: 1em;
	}
	dl[compact] > dt {
		margin-right: 0em;
	}
	dl[compact] > dt::after {
		padding: 0 1px;
		content: "=";
	}
	abbr {
		font-variant-caps: small-caps;
	}
	
	body {
		background-repeat: repeat-y;
		background-image: repeating-linear-gradient(135deg, black 0 5px, yellow 0 10px);
		background-size: 24px 100%;
		margin-left: 32px;
	}
	
	body > * {
		max-width: 7in;
	}
	
	todo {
		background-image: repeating-linear-gradient(135deg, white 0 5px, #FF8 0 10px);
		border: 1px solid black;
		border-radius: 4px;
		padding: 0 2px;
	}
	todo::before {
		content: "TODO: ";
	}
</style>

<style>
	dl.bits {
		display: grid;
		grid: auto-flow dense / max-content max-content 1fr;
		margin-left: 1em;
		margin-top: 0.25em;
		margin-bottom: 0em;
	}
	dl.bits > * {
		align-self: baseline;
	}
	dl.bits > dt {
		font-size: 18px;
		margin-right: 6px;
		justify-self: right;
		grid-column: 2 / 3;
		margin-bottom: 2px;
	}
	dl.bits > dt + dt {
		grid-column: 1 / 2;
		font-size: 14px;
		font-weight: normal;
		color: #468;
		margin-right: 2px;
	}
	dl.bits > dt:not(dt+dt) {
		display: flex;
		justify-self: stretch;
		//text-shadow: 0.5px 0.5px 1px #4688;
	}
	dl.bits > dt:not(dt+dt)::after {
		text-shadow: none;
		color: #468;
		content: ":";
	}
	dl.bits > dt:not(dt+dt)::before {
		content: " ";
		flex: 1;
		white-space: pre;
		margin-right: 2px;
		margin-left: 2px;
		border-bottom: 1px dotted #468;
		height: 11px;
	}
	dl.bits > dt + dt::before { color: black; content: "{"; }
	dl.bits > dt + dt::after { color: black; content: "}"; }
	dl.bits > dd {
		margin: 0;
		grid-column: 3 / 4;
	}

	f3-struct f3-addr > dl {
		margin-bottom: 0.5em;
	}
	f3-struct f3-data > dl:not(:last-child) {
		margin-bottom: 0.25em; /*hack*/
	}
</style>

<style>
	table.bits {
		table-layout: fixed;
		border-spacing: 0;
		border: 2px groove;
		counter-reset: bnum 16;
	}
	table.bits tr>* {
		width: 18px;
		max-width: 18px;
		text-align: center;
		text-shadow: 1px 0 white;
	}
	table.bits th {
		font-family: courier, monospace;
		font-size: 9.5px;
		padding: 0;
		font-weight: normal;
		border-right: 1px inset;
	}
	table.bits th::after {
		content: counter(bnum);
		counter-increment: bnum -1;
		color: gray;
	}
	table.bits td {
		padding: 1px 0;
		border-top: 1px solid #DDD;
		padding-top: 0;
	}
	table.bits th:nth-child(4n) { border-right: 1px outset; }
	table.bits th:nth-child(4n+1) { border-left: 1px outset; }
	table.bits tr>:last-child { border-right: none; }
	table.bits tr>:first-child { border-left: none; }
	table.bits td:nth-child(2n) { background: linear-gradient(to top, white, #DDD); }
	table.bits td:nth-child(2n+1) { background: linear-gradient(to bottom, white, #DDD); }
	table.bits td:nth-child(n) {
		background: linear-gradient(to right, white, #DDD);
		background: linear-gradient(to right, white, #DDD calc((8px + 100%) / 2));
		background: linear-gradient(110deg, white, #E7E7E7 calc(8px + 20%) calc(100% - 8px - 15%), #ccc);
}
	}
	table.bits td.space { background: linear-gradient(to bottom right, white, #DDD); }
	/*table.bits td.x { background: #DDD; }*/
	table.bits td.x {
		font-variant: tabular-nums;
		background: #ddd;
	}
	table.bits td.x:last-child { background: #eee; }
	
	@supports (font-variant-position: sub) {
		sub, sup {
			font-size: unset;
			vertical-align: unset;
		}
		sub { font-variant-position: sub; }
		sup { font-variant-position: super; }
	}
	@supports not (font-variant-position: sub) {
		sub, sup {
			font-size: 81.25%;
			line-height: 0;
			position: relative;
			vertical-align: baseline;
		}
		sub { bottom: -0.25em; }
		sup { top: -0.5em; /* todo: check this */ }
	}
</style>

a general note: unless otherwise stated, there is no "cost" to using any feature. i.e. it will not lower the framerate or disable access to other features. you can basically enable every feature, change every setting on every scanline, etc. with the only investment being the time it takes to actually configure graphics ram. otherwise the fdp is basically  branchless

<table class=bits><tr><th><th><th><th><th><th><th><th><th><th><th><th><th><th><th><th><tr><td colspan=2>B<td>E<td>I<td>c<td class=c>c<td class=c>c<td class=c>c<td>i<td>i<td>i<td>i<td colspan=4>p</table>
<table class=bits><tr><th><th><th><th><th><th><th><th><th><th><th><th><th><th><th><th><tr>hccc cccv tttt tttt</table>
	
<h1>Clipping</h1>
<p>there are four global clipping intervals, each consisting of a left and right value. each layer (with sprite groups sharing clip settings) has the following clip settings:
<dl>
	<dt>layer enable<dd>(idk if this counts as clipping but it's near the others)
	<dt>global clip invert<dd>invert all clipping
	<dt>clip plane enable<dd>1 = enabled
	<dt>clip plane mode<dd>0 = hide inside, 1 = hide outside
</dl>
(todo)
	
<p>to help you get your bearings, here is an overview of the layout of graphics ram: (todo: baby mode table)</p>

<p>There are four playfields consisting of a 32x32 or 64x32 grid of 16x16px tiles.</p>

<f3-struct>
	<h1>Playfield Tile</h1>
	<f3-addr>
		<h1>Address (normal)</h1>
		<f3-bits>&ctdot;,0,0,1,0,pf:3,y:5,x:5,-:2</f3-bits>
		<h1>Address (extend mode)</h1>
		<f3-bits>&ctdot;,0,0,1,pf:3,y:5,x:6,-:2</f3-bits>
		<dl class=bits>
			<dt>pf<dd>playfield id
				<dl>
					<dt>0,1,2,3<dd>regular playfield data
					<dt>4,5<dd>alternate data for playfields 2 and 3
				</dl>
			<dt>y<dd>y index (0-31)
			<dt>x<dd>x index (0-31 or 0-64)
		</dl>
	</f3-addr>
	<f3-data>
		<h1>Data</h1>
		<f3-bits>h,v,chr2:2,bpp:2,bs,palette:9,character:16</f3-bits>
		<dl class=bits>
			<dt>character<dt>0:16<dd>character id (lower bits)
			<dt>palette<dt>16:9<dd>palette id (0&ctdot;511)
			<dt>bs<dt>25:1<dd>blend select
			<dt>bpp<dt>26:2<dd>texture bit planes (bits per pixel select)
				<dl compact>
					<dt>0<dd>4bpp
					<dt>1<dd>5bpp
					<dt>2<dd>?
					<dt>3<dd>6bpp
				</dl>
			<dt>chr2<dt>28:2<dd>character id (upper bits)
			<dt>v<dt>30:1<dd><dl compact><dt>1<dd>vertical flip</dl>
			<dt>h<dt>31:1<dd><dl compact><dt>1<dd>horizontal flip</dl>
		</dl>
	</f3-data>
</f3-struct>

<p>the pivot layer is a 64x64 grid of 8x8 tiles, which gets its textures from RAM instead of ROM. it can either be in "text mode" (where the texture is looked up based on the tile's id) or "pixel mode" (where each cell has a unique texture, whose address depends on its position in the grid, effectively giving you a 512x256 bitmap, though the pixels are in a weird order)</p>

<f3-struct>
	<h1>Pivot Tile</h1>
	<f3-addr>
		<h1>Address</h1>
		<f3-bits>&ctdot;,0,1,1,1,0,y:6,x:6,-</f3-bits>
		<dl>
			<dt>y<dd>y index (0-63)
			<dt>x<dd>x index (0-63)
		</dl>
	</f3-addr>
	<f3-data>
		<h1>Data</h1>
		<f3-bits>h,pal:6,v,chr:8</f3-bits>
		<dl>
			<dt>chr<dd>character id (0-255)
			<dt>v<dd><dl compact><dt>1<dd>vertical flip</dl>
			<dt>pal<dd>palette id (0-63)
			<dt>h<dd><dl compact><dt>1<dd>horizontal flip</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Pivot Texture</h1>
	<f3-addr>
		<h1>Address (Text Mode)</h1>
		<f3-bits>&ctdot;,0,1,1,1,1,chr:8,-:5</f3-bits>
		<dl>
			<dt>chr<dd>character id (0-255)
		</dl>
		<h1>Address (Pixel Mode)</h1>
		<f3-bits>&ctdot;,1,b,x:6,y:5,-:5</f3-bits>
		<dl>
			<dt>b<dd>pivot pixel bank (set in lineram)
			<dt>x<dd>tile x index (0-63)
			<dt>y<dd>tile y index (0-31; top and bottom halves of the pivot layer use same textures in pixel mode)
		</dl>
	</f3-addr>
	<f3-data>
		<h1>Data (×8)</h1>
		<f3-bits>b:4,b:4,b:4,b:4,b:4,b:4,b:4,b:4</f3-bits>
		<dl>
			<dt>b<dd>data for 1 pixel <todo>describe the bit order better - maybe we need a separate page for bitmap formats because they are all different</todo>
		</dl>
	</f3-data>
</f3-struct>

<p>pixel mode is similar to text mode, but the data for each tile is fetched based on the tile's position rather than the tile index in the text data.</p>

<f3-struct>
	<h1>common layer properties</h1>
	<dl>
		<dt>display enable<dd><dl compact><dt>0<dd>off<dt>1<dd>on</dl>(todo: hm does disabling turn off the updating of y position based on zoom?)
		<dt>priority<dd>0-15. higher = above other things. two layers with the same priority can cause a conflict.
		<dt>clip invert<dd><dl compact><dt>0<dd>normal<dt>1<dd>inverted</dl>
		<dt>clip plane enable ×4<dd>one per clip plane<dl compact><dt>0<dd>off<dt>1<dd>on</dl>
		<dt>clip plane mode ×4<dd>one per clip plane<dl compact><dt>0<dd>hide inside<dt>1<dd>hide outside</dl>
		<dt>blend mode<dd>which half-pixel(s) to contribute to. encoding varies by layer
		<dt>blend select<dd>which of the 2 possible blend values will be used for a given half-pixel
		<dt>mosaic enable<dd><dl compact><dt>0<dd>off<dt>1<dd>on</dl>
	</dl>
</f3-struct>

<p>note: lineram section 0 is missing its first 2 subsections (0.0 "4000" and 0.1 "4200"), so per-line y scroll adjust and alternate tilemap are only available on playfields 2 and 3.</p>

<f3-struct>
	<h1>Lineram Section 0.2 "4400" - “Colscroll”, Alt Tilemap, Clip Bits</h1>
	<f3-data>
		<f3-bits>1<sub>R</sub>,1<sub>L</sub>,0<sub>R</sub>,0<sub>L</sub>,?:2,alt,yscroll:9</f3-bits>
		<dl>
			<dt>yscroll<dd><i>playfield 2</i>: y scroll adjust <todo>data format</todo>
			<dt>alt<dd><i>playfield 2</i>: tile data location<dl compact><dt>0<dd>normal<dt>1<dd>alternate (tilemap number+2)</dl>
			<dt>0<sub>L</sub><dd>clip plane 0 left (upper bit)
			<dt>0<sub>R</sub><dd>clip plane 0 right (upper bit)
			<dt>1<sub>L</sub><dd>clip plane 1 left (upper bit)
			<dt>1<sub>R</sub><dd>clip plane 1 right (upper bit)
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 0.3 "4600"</h1>
	<div>(same as 0.3, but for playfield 3 and clip planes 2 and 3)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 1.0 "5000" - Clip Plane Values</h1>
	<f3-data>
		<f3-bits>right:8,left:8</f3-bits>
		<dl>
			<dt>left<dd><i>clip plane 0</i> left (lower bits)<br>
				<todo>data format</todo>
			<dt>right<dd><i>clip plane 0</i> right (lower bits)
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 1.1 "5200"</h1>
	<div>(same as 1.0, but for clip plane 1)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 1.2 "5400"</h1>
	<div>(same as 1.0, but for clip plane 2)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 1.3 "5600"</h1>
	<div>(same as 1.0, but for clip plane 3)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 2.0 "6000" - Misc Blending, Pivot Mode</h1>
	<f3-data>
		<f3-bits>B,?,P,?,o,b,p,h,s<sub>3</sub>:2,s<sub>2</sub>:2,s<sub>1</sub>:2,s<sub>0</sub>:2</f3-bits>
		<dl>
			<dt>s<sub>n</sub><dd><i>sprite group n</i>: blend mode (note 0 and 3 are swapped)<dl compact><dt>0<dd>neither<dt>1<dd>left<dt>2<dd>right<dt>3<dd>both</dl>
			<dt>h<dd><i>highcolor layer</i>: blend value select
			<dt>p<dd><i>pivot</i>: blend value select
			<dt>b<dd><i>background color</i>: blend value select
			<dt>o<dd>tilemap infinite vertical stretch?
			<dt>P<dd><i>pivot</i>: mode<dl compact><dt>0<dd>text<dt>1<dd>pixel</dl>
			<dt>B<dd><i>pivot</i>: pixel data location<dl compact><dt>0<dd>$620000 (conflicts with lineram)<dt>1<dd>$630000</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 2.1 "6200" - Blend Alpha Values</h1>
	<f3-data>
		<f3-bits>left1:4,left0:4,right1:4,right0:4</f3-bits>
		<dl>
			<dt>right0<dd>right half-pixel, blend select = 0<br>alpha = clamp((15-value)/8, 0, 1)<dl compact><dt>$0-$7<dd>100%<dt>$B<dd>50%<dt>$F<dd>0%</dl>
			<dt>right1<dd>right half-pixel, blend select = 1
			<dt>left0<dd>left half-pixel, blend select = 0
			<dt>left1<dd>left half-pixel, blend select = 1
		</dl>
	</f3-data>
</f3-struct>
	
<f3-struct>
	<h1>Lineram Section 2.2 "6400" - Mosaic and <abbr>Fda</abbr> Settings</h1>
	<f3-data>
		<f3-bits>fda:2,b,?,S,g,h,s,mosaic:4,p<sub>3</sub>,p<sub>2</sub>,p<sub>1</sub>,p<sub>0</sub></f3-bits>
		<dl>
			<dt>p<sub>n</sub><dd><i>playfield n</i>: mosaic enable
			<dt>mosaic<dd>mosaic strength: samples every [16&minus;m] pixels
			<dt>s<dd><i>sprites</i>: mosaic enable
			<dt>h<dd><i>hicolor layer</i>: mosaic enable
			<dt>g<dd>shadow mode alternate: if shadow mode is enabled, changes its behavior <todo>figure this out</todo>
			<dt>S<dd>"shadow mode": if 2 layers have <u>neighboring priorities</u> and the lower one is non-empty, the upper layer's palette is altered: 4th bit of the color index (i.e. the 0th bit of the palette id) is set to 1 - todo: this may be different depending on the bpp setting<br>
				notes: this effect is done separately for every half pixel (this effect is probably implemented inside the priority cell array, unlike everything else). note: the background color layer (as well as priority conflicts) count as empty pixels
			<dt>b<dd><i><abbr>fda</abbr></i>: horizontal blur<dl compact><dt>0<dd>blurred<dt>1<dd>normal</dl>
			<dt>fda<dd><i><abbr>fda</abbr></i> mode<dl><dt>0<dd>15-bit <abbr>rgb</abbr> format (legacy mode)<dt>1<dd>normal mode<dt>2<dd>no blending, display half-pixels separately (debug mode?)<dt>3<dd>invalid? first pixel repeats all the way across</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 2.3 "6600" - Background Color</h1>
	<f3-data>
		<f3-bits>.:3,color:13</f3-bits>
		<dl>
			<dt>color<dd><i>background color</i>: <i>color index</i>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 3.0 "7000" - Highcolor Layer Blending</h1>
	<f3-data>
		<f3-bits>bm:2,E,I,c<sub>3</sub>,c<sub>2</sub>,c<sub>1</sub>,c<sub>0</sub>,i<sub>3</sub>,i<sub>2</sub>,i<sub>1</sub>,i<sub>0</sub>,prio:4</f3-bits>
		<dl>
			<dt>prio<dd><i>highcolor layer</i>: priority (0-15)
			<dt>i<sub>n</sub><dd><i>highcolor layer</i>: clip plane n mode
			<dt>c<sub>n</sub><dd><i>highcolor layer</i>: clip plane n enable
			<dt>I<dd><i>highcolor layer</i>: clip invert
			<dt>E<dd><i>highcolor layer</i>: enable
			<dt>bm<dd><i>highcolor layer</i>: blend mode<dl compact><dt>0<dd>both<dt>1<dd>right?<dt>2<dd>right?<dt>3<dd>right?</dl><todo>figure out what 1,2,3 do</todo>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 3.1 "7200" - Pivot Layer Blending</h1>
	<f3-data>
		<f3-bits>bm,?,E,I,c<sub>3</sub>,c<sub>2</sub>,c<sub>1</sub>,c<sub>0</sub>,i<sub>3</sub>,i<sub>2</sub>,i<sub>1</sub>,i<sub>0</sub>,prio:4</f3-bits>
		<dl>
			<dt>prio<dd><i>pivot</i>: priority (0-15)
			<dt>i<sub>n</sub><dd><i>pivot</i>: clip plane n mode
			<dt>c<sub>n</sub><dd><i>pivot</i>: clip plane n enable
			<dt>I<dd><i>pivot</i>: clip invert
			<dt>E<dd><i>pivot</i>: enable
			<dt>bm<dd><i>pivot</i>: blend mode (note different interpretation than elsewhere)<dl compact><dt>0<dd>both<dt>1<dd>left</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 3.2 "7400" - Sprite Blending</h1>
	<f3-data>
		<f3-bits>s<sub>3</sub>,s<sub>2</sub>,s<sub>1</sub>,s<sub>0</sub>,?,?,E,I,c<sub>3</sub>,c<sub>2</sub>,c<sub>1</sub>,c<sub>0</sub>,i<sub>3</sub>,i<sub>2</sub>,i<sub>1</sub>,i<sub>0</sub></f3-bits>
		<dl>
			<dt>i<sub>n</sub><dd><i>sprites</i>: clip plane n mode
			<dt>c<sub>n</sub><dd><i>sprites</i>: clip plane n enable
			<dt>I<dd><i>sprites</i>: clip invert
			<dt>E<dd><i>sprites</i>: enable
			<dt>s<sub>n</sub><dd><i>sprite group n</i>: <i>blend select</i>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 3.3 "7600" - Sprite Priorities</h1>
	<f3-data>
		<f3-bits>prio<sub>3</sub>:4,prio<sub>2</sub>:4,prio<sub>1</sub>:4,prio<sub>0</sub>:4</f3-bits>
		<dl>
			<dt>prio<sub>n</sub><dd><i>sprite group n</i>: priority
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 4.0 "8000" - Playfield 0 Zoom</h1>
	<f3-data>
		<f3-bits>hzoom:8,vzoom:8</f3-bits>
		<dl>
			<dt>vzoom<dd><i>playfield 0</i>: vertical zoom<br>
				factor = 1 / (zoom/128)
				<dl compact><dt>$00<dd>∞×<dt>$40<dd>2×<dt>$80<dd>1×<dt>$C0<dd>0.667×<dt>$FF<dd>0.502×</dl>
			<dt>hzoom<dd><i>playfield 0</i>: horizontal zoom<br>
				factor = 1 / (1 - zoom/256)
				<dl compact><dt>$00<dd>1×<dt>$40<dd>1.333×<dt>$80<dd>2×<dt>$C0<dd>4×<dt>$FF<dd>256×</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 4.1 "8200" - Playfield 1 Zoom</h1>
	<f3-data>
		<f3-bits>hzoom:8,vzoom:8</f3-bits>
		<dl>
			<dt>vzoom<dd><i>playfield 3</i>*: vertical zoom<br>*bug: playfields 1 and 3 have their vertical zooms swapped
			<dt>hzoom<dd><i>playfield 1</i>: horizontal zoom
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 4.2 "8400" - Playfield 2 Zoom</h1>
	<f3-data>
		<f3-bits>hzoom:8,vzoom:8</f3-bits>
		<dl>
			<dt>vzoom<dd><i>playfield 2</i>: vertical zoom
			<dt>hzoom<dd><i>playfield 2</i>: horizontal zoom
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 4.3 "8600" - Playfield 3 Zoom</h1>
	<f3-data>
		<f3-bits>hzoom:8,vzoom:8</f3-bits>
		<dl>
			<dt>vzoom<dd><i>playfield 1</i>*: vertical zoom
			<dt>hzoom<dd><i>playfield 3</i>: horizontal zoom
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 5.0 "9000" - Playfield 0 Palette Adjust</h1>
	<f3-data>
		<f3-bits>.:10,palette:6</f3-bits>
		<dl>
			<dt>palette<dd><i>playfield 0</i>: added to the palette of all tiles
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 5.1 "9200"</h1>
	<div>(same as 5.0, but for playfield 1)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 5.2 "9400"</h1>
	<div>(same as 5.0, but for playfield 2)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 5.3 "9600"</h1>
	<div>(same as 5.0, but for playfield 3)</div>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 6.0 "A000" - "Rowscroll"</h1>
	<f3-data>
		<f3-bits>xscroll:16</f3-bits>
		<dl>
			<dt>xscroll<dd><i>playfield 0</i>: x scroll adjust (same format as global scroll)
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 7.0 "B000" - Playfield 0 Blending</h1>
	<f3-data>
		<f3-bits>bm:2,E,I,c<sub>3</sub>,c<sub>2</sub>,c<sub>1</sub>,c<sub>0</sub>,i<sub>3</sub>,i<sub>2</sub>,i<sub>1</sub>,i<sub>0</sub>,prio:4</f3-bits>
		<dl>
			<dt>prio<dd><i>playfield 0</i>: priority (0-15)
			<dt>i<sub>n</sub><dd><i>playfield 0</i>: clip plane n mode
			<dt>c<sub>n</sub><dd><i>playfield 0</i>: clip plane n enable
			<dt>I<dd><i>playfield 0</i>: clip invert
			<dt>E<dd><i>playfield 0</i>: enable
			<dt>bm<dd><i>playfield 0</i>: blend mode<dl compact><dt>0<dd>both<dt>1<dd>left<dt>2<dd>right<dt>3<dd>neither</dl>
		</dl>
	</f3-data>
</f3-struct>

<f3-struct>
	<h1>Lineram Section 7.2 "B200"</h1>
	<div>(same as 7.0, but for playfield 1)</div>
</f3-struct>

<f3-struct>
	<h1>Sprite List Entry</h1>
	<f3-addr>
		<h1>Address</h1>
		<f3-bits>&ctdot;,0,0,bank:2,index:10,f:3,-</f3-bits>
		<dl>
			<dt>bank<dd>bank (set by command)
			<dt>index<dd>sprite id
			<dt>field<dd>field number
		</dl>
	</f3-addr>
	<f3-data>
		<h1>Field 0</h1>
		<f3-bits>chr:16</f3-bits>
		<dl>
			<dt>chr<dd>character id (lower bits)
		</dl>
		<h1>Field 1</h1>
		<f3-bits>yzoom:8,xzoom:8</f3-bits>
		<dl>
			<dt>xzoom<dd>horizontal zoom<br>
				scale = 1 - zoom/256
				<dl compact><dt>$00<dd>1×<dt>$40<dd>0.75×<dt>$80<dd>0.5×<dt>$C0<dd>0.25×<dt>$FF<dd>0.004×</dl>
			<dt>yzoom<dd>vertical zoom (same format)
		</dl>
		<h1>Field 2</h1>
		<f3-bits>i:2,s:2,x:12</f3-bits>
		<dl>
			<dt>x<dd>x position (signed int, pixels)
			<dt>s<dd>set scrolls from position value (happens first)
				<dl compact><dt>0<dd>neither<dt>1<dd>local<dt>2<dd>global<dt>3<dd>both</dl>
			<dt>i<dd>adjust position
				<dl compact><dt>0 or 2<dd>add both scrolls<dt>1<dd>add global scroll<dt>3<dd>none</dl>
		</dl>
		<h1>Field 3</h1>
		<f3-bits>c,.:3,y:12</f3-bits>
		<dl>
			<dt>y<dd>y position (signed int, pixels)
			<dt>c<dd><dl compact><dt>1<dd>command mode</dl>
		</dl>
		<h1>Field 4</h1>
		<f3-bits>x:2,?,y,M,p,v,h,pal:8</f3-bits>
		<dl>
			<dt>pal<dd>palette id (0-255)
			<dt>h<dd>horizontal flip
			<dt>v<dd>vertical flip
			<dt>p<dd>palette lock<dl compact><dt>1<dd>reuse previous palette<dt>0<dd>use new palette</dl>
			<dt>M<dd>"multi" - <u>this bit affects the next sprite not the current one</u><dl compact><dt>0<dd>read zoom value, and update block origin from given position<dt>1<dd>don't</dl>
			<dt>y<dd>y tessellation control (where to place sprite)<dl compact><dt>0<dd>at block origin (if M was 0, this will be the given position)<dt>1<dd>south of prev sprite</dl>
			<dt>x<dd>x tessellation control (where to place sprite)<dl compact><dt>0<dd>at the given position<dt>1<dd>same as prev sprite<dt>2* or 3<dd>right of prev sprite</dl>*2 is the same as 3, but the first row is rendered at the wrong position for some reason
		</dl>
		<h1>Field 5 (always, affects current sprite)</h1>
		<f3-bits>.:8,fmt:4,?,?,chr2:2</f3-bits>
		<dl>
			<dt>chr2<dd>character id (upper bits) - this might be more than 2 bits
			<dt>fmt<dd>bitmap format - affects the order of pixels loaded from rom?
		</dl>
		<h1>Field 5 (additional effects in command mode, sets persistent settings)</h1>
		<f3-bits>?,?,k,j,?,b<sub>1</sub>,g,f,?,a:3,?,?,t,b<sub>0</sub></f3-bits>
		<dl>
			<dt>b<sub>0</sub><dd>lower bit of bank
			<dt>t<dd>? supposedly disables clearing framebuffer but seems to be something else
			<dt>a<dd>? affects visiblity of sprites or something
			<dt>f<dd>sets palettes to 0(?), and then adds some garbage pixels around the sprites which do a palette offset? not sure where these come from, they seem consistent?
			<dt>g<dd>similar to f but different
			<dt>b<sub>1</sub><dd>upper bit of bank
			<dt>j<dd>changes video signal (causes us to lose sync, but definitely still outputting a picture)
			<dt>k<dd>flipscreen
		</dl>
		<h1>Field 6</h1>
		<f3-bits>j,.:5,dest:10</f3-bits>
		<dl>
			<dt>dest<dd>jump destination (next sprite index to process)
			<dt>j<dd><dl compact><dt>1<dd>do a jump<dt>0<dd>increment index normally</dl>
		</dl>
	</f3-data>
</f3-struct>

<script>
	for (let e of document.querySelectorAll('f3-bits')) {
		if (/,|:/.test(e.textContent)) {
			let n = e.innerHTML.split(",")
			let l = 0
			let d = n.map(m=>{
				m = m.split(":")
				console.log(m)
				let c = (+m[1])||1
				l += c
				return `<td${/^(⋯|-|0|1|\.)$/.test(m[0])?" class=x":""} colspan=${c}>${m[0]}`
			})
			e.outerHTML = `<table class=bits><tr style="counter-reset:bnum ${l}">${"<th>".repeat(l)}<tr>${d.join("")}</table>`
		} else {
			let n = e.textContent.replace(/ /g,"")
			e.outerHTML = `<table class=bits><tr style="counter-reset:bnum ${n.length}">${"<th>".repeat(n.length)}<tr>${n.replace(/[01]|([^01])( ?\1)*/g, (m)=>`<td${m[0]<="1"?" class=x":""} colspan=${m.length}>${m[0]}`)}</table>`
		}
	//	e.innerHTML = e.innerHTML.replace(/([a-zA-Z])( ?\1)*/g, "<b>$&</b>")
	}
</script>
